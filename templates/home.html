{% extends "base.html" %}
{% load staticfiles %}

{% block title %}{% endblock %}

{% block meta %}
<meta name="description" content="reSRC, the root of actual learning" />
{% endblock %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{% static "js/jquery-ui/theme/jquery-ui.css" %}" />
<link href="{% static "js/tagit/theme/jquery.tagit.css" %}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block breadcrumb_container %} {% endblock %}

{# Content #}

{% block content %}

{% if not user.is_authenticated %}
<div class="row welcome">
  <div class="large-12 columns">
    <div class="panel">
      <div style="position: absolute; right: 30px; top: 10px; font-size: 2em;"><a href="#" id="close">&#215;</a></div>
      <h1><span>Find Y resources about X in <span class="show-for-medium">Zero</span><span class="hide-for-medium">0</span> minutes</span></h1>
      <div class="row">
        <div class="large-3 columns">
          <p>
            <a href="{% url "user-register" %}" class="button large-12">Register now!</a>
          </p>
        </div>
        <div class="large-9 columns">
          <p>Sometimes, search engines fail at recommending the best resources about a specific topic. Curated lists are an awesome way to find stuff you might really want to read.</p>
          <p>Find articles, tutorials, documentation, screencasts just about anything programming related. Browse by <strong>tags</strong>, read <strong>curated lists</strong>, upvote lists and links you like.</p>
          <p>Create and publish your lists or import them directly (e.g. from GitHub) in Markdown, add links to your Reading List.</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="medium-6 large-3 columns">
    <h3><a href="{% url "lists" %}">Best lists</a></h3>
    <ul class="no-bullet">
      {% for list in hottest_lists %}
      <li><span class="votes y-bg" data-id="{{list.alist__pk}}" data-type="list">{{ list.count }} <i class="lsf{% if list.alist__pk in upvoted_lists %} lsf2{% endif %}"></i></span><a href="{% url "list-single-slug" list.alist__pk list.alist__slug %}">{{ list.alist__title }}</a></li>
      <hr>
      {% endfor %}
    </ul>
  </div>

  <div class="medium-6 large-3 columns">
    <h3><a href="{% url "links" %}">Latest links</a></h3>
    <ul class="no-bullet">
      {% for link in latest_links %}
      <li><i class="lsf i-b t-i">link</i><span class="votes y-bg" data-type="link" data-id="{{link.link__pk}}">{{ link.count }} <i class="lsf{% if link.link__pk in upvoted_links %} lsf2{% endif %}"></i></span><a href="{% url "link-single-slug" link.link__pk link.link__slug %}">{{ link.link__title }}</a></li>
      <hr>
      {% endfor %}
    </ul>
  </div>

  <div class="medium-6 large-3 columns">
    <h3><a href="{% url "tag-index" %}">Most used tags</a></h3>
    <div>
      {% for tag in tags %}{% if tag.slug %}
      <p class="tag left"><a href="{% url "tag-single-slug" tag.slug %}"><span class="c">{{ tag.c }}</span><span class="t">{{ tag.name }}</span></a></p>
      {% endif %}{% endfor %}
    </div>
  </div>

  <div class="medium-6 large-3 columns">
    <h3><a href="{% url "links" %}">Hottest links</a></h3>
    <ul class="no-bullet">
      {% for link in hottest_links %}
      <li><i class="lsf i-b t-i">link</i><span class="votes y-bg" data-type="link" data-id="{{link.link__pk}}" data-type="link"> {{ link.count }} <i class="lsf{% if link.link__pk in upvoted_links %} lsf2{% endif %}"></i></span><a href="{% url "link-single-slug" link.link__pk link.link__slug %}">{{ link.link__title }}</a></li>
      <hr>
      {% endfor %}
    </ul>
  </div>
</div>

<div class="row">
  <div class="large-12 columns panel">
    <h6>legend</h6>
    <ul class="no-bullet inline-list">
      <li><a href="#"><span class="votes y-bg" data-tooltip title="Click to upvote">74 <i class="lsf"></i></span>I'm a list with 74 votes</a></li>
      <li class="tag" style="margin-top: 5px"><a href="#"><span class="c">8</span><span class="t">I'm a tag with 8 links</span></a></li>
      <li><a href="#"><i class="lsf i-b t-i">link</i><span class="votes y-bg" data-tooltip title="Click to upvote">17 <i class="lsf"></i></span>I'm a link with 17 votes</a></li>
    </ul>
  </div>
</div>


<div class="row">
  <div class="large-12 columns">
    <h1 id="query">Search by tags</h1>
  </div>
</div>

<div class="row">
  <div class="large-2 small-2 columns">
    <p>
      <input type="radio" name="op" id="op-or" value="or" checked="checked">
      &nbsp;
      <label for="op-or" style="display: inline;"><strong>or</strong></label>
      <br />
      <input type="radio" name="op" id="op-and" value="and">
      &nbsp;
      <label for="op-and" style="display: inline;"><strong>and</strong></label>
    </p>
  </div>
  <div class="large-10 columns">
    <input type="text" id="tags" value=""/>
  </div>
</div>

<div class="row">
  <div class="large-2 small-2 columns">
    <p><strong>exclude tags :</strong></p>
  </div>
  <div class="large-10 small-10 columns">
    <input type="text" id="tags2" value=""/>
  </div>
</div>

<div class="row">
  <div class="large-6 columns">
    <h4>Links</h4>
    <div id="link_results"></div>
  </div>
  <div class="large-6 columns">
    <h4>Lists</h4>
    <div id="list_results"></div>
  </div>
</div>

{% endblock %}

{% block last_body %}
{% if user.is_authenticated %}
<script>
  window.csrfToken = '{{ csrf_token }}';
</script>
<script src="{% static "js/votes.js" %}"></script>
{% else %}
<div id="login-modal" class="reveal-modal"></div>
<script>
$(function () {
  $('#vote, .votes').click(function() {
    $('#login-modal').foundation('reveal', 'open', {
      url: "http://resrc.io{% url "user-login-modal" %}"
    });
  });
  $('#close').click(function() {
    document.cookie = "hide=True";
    $('.welcome').remove();
  });
});

var x = document.cookie;
var hideDiv = x.split(";");
for(i = 0; i < hideDiv.length; i++)
if(hideDiv[i] == " hide=True") {
  $('.welcome').remove();
}
</script>
{% endif %}

<script type="text/javascript" src="{% static "js/jquery-ui/jquery-ui.min.js" %}" ></script>
<script type="text/javascript" src="{% static "js/tagit/tag-it.min.js" %}" ></script>
<script type="text/javascript">
  $(function(){
    var search = function() {
      var tags = $('#tags').val();
      var excludes = $('#tags2').val();
      var op = $('input[name="op"]:checked').val();

      var url = '/search/'+tags+'%25'+op+'%25'+excludes;

      var query = tags.split(',').join(' '+(op == 'and' ? '&' : '|')+' ');
      if (excludes.length > 0) {
        query += ' ~(';
        query += excludes.split(',').join(' | ');
        query += ')';
      }


      if (query.length === 0) {
        $('#query').html('Search by tags');
        return;
      } else {
        $('#query').html('<a href="/page'+url+'">'+query+'</a>');
        console.log('hehe');
        $.ajax({
          type:"GET",
          url: '/tag' + url,
          success: function(result) {
            result = $.parseJSON(result);
            $('#link_results,#list_results').html('');
            if (result[0].length > 0) {
              for (var i = 0; i < result[0].length; i++) {
                link = result[0][i];
                $('#link_results').append('<div class="panel">'
                  + '<h5>'+(i+1)+'. <a href="'+link.url+'">'+link.title+'</a></h5>'
                  + '</div>');
              }
            } else {
              $('#link_results').append('<div class="panel"><h5>Sorry, no result.</h5></div>');
            }
            if (result[1].length > 0) {
              for (var i = 0; i < result[1].length; i++) {
                list = result[1][i];
                $('#list_results').append('<div class="panel">'
                  + '<h5>'+(i+1)+'. <a href="'+list.url+'">'+list.title+'</a></h5>'
                  + '</div>');
              }
            } else {
              $('#list_results').append('<div class="panel"><h5>Sorry, no result.</h5></div>');
            }
          }
        });
      }
    };

    $('#tags').tagit({
      availableTags: [{{ csvtags|safe }}],
      autocomplete: {delay: 0, minLength: 2},
      allowSpaces: true,
      afterTagAdded: search,
      afterTagRemoved: search
    });

    $('#tags2').tagit({
      availableTags: [{{ csvtags|safe }}],
      autocomplete: {delay: 0, minLength: 2},
      allowSpaces: true,
      afterTagAdded: search,
      afterTagRemoved: search
    });

    $('input[name="op"]').on('change', search);

  });
</script>
{% endblock %}
