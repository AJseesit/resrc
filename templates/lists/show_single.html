{% extends "lists/base.html" %}
{% load profile %}
{% load staticfiles %}
{% load mptt_comments_tags %}
{% load crispy_forms_tags %}
{% load emarkdown %}

{% block meta %}
<script type="text/javascript">var jq = true;</script>
{% endblock %}

{% block title %}
{{ list.title }}
{% endblock %}


{% block extrahead %}
{% if request.user.is_authenticated %}
<link rel="stylesheet" type="text/css" href="{% static "js/jquery-ui/theme/jquery-ui.css" %}" />
<link href="{% static "js/tagit/theme/jquery.tagit.css" %}" rel="stylesheet" type="text/css"/>
{% endif %}
<link rel="canonical" href="{{ list.get_absolute_url }}" />
{% endblock %}


{% block breadcrumb %}
<li><a href="{% url "home" %}">Home</a></li>
<li><a href="">Lists</a></li>
<li class="current">{{ list.title }}</li>
{% endblock %}

{% block content %}

<div class="row">
  <div class="large-12 columns">
    <p>
      {% for name, slug, count in tags %}{% if slug %}
      <p class="tag left"><a href="{% url "tag-single-slug" slug %}"><span class="c">{{ count }}</span><span class="t">{{ name }}</span></a></p>
      {% endif %}{% endfor %}
    </p>
  </div>
</div>

<div class="row">
  <div class="large-12 columns">
    <h1>{{ list.title }}{% if request.user.is_authenticated %}<a class="lsf symbol right i-b" id="vote" data-tooltip title="Vote for this list">check</a>{% endif %}</h1>
    <p>{{ list.description|emarkdown }}</p>
    <p class="byline">
      {% with author=list.owner %}
      by <a href="{% url "user-url" author.username %}">{{ author.username }}</a> | {{ list.pubdate|timesince }} ago | <span class="votes lsf">{{ count }}</span><span class="views lsf">{{ list.views }}</span>{% if author = request.user %} | <a href="{% url "list-edit" list_pk=list.pk %}">edit</a>{% endif %}
      {%endwith%}
    </p>
  </div>
</div>

<div class="row">
  <div class="large-12 columns{% if list.owner = request.user %} my-def-list{% endif %}">
    {% if list.title in default_lists %}
    {% with links=list.links.all %}
    {% for link in links %}
    <hr />
    <h4><a href="{{ link.get_absolute_url }}"><i class="lsf symbol i-b">link</i> {{ forloop.counter }}.</a> <a href="{{ link.url }}">{{ link.title }}</a>{% if list.owner = request.user %}<span class="del has-tip tip-top" data-tooltip title="Remove link from list"> x </span>{% endif %}</h4>
    <p class="byline">
      <a href="{{ link.get_absolute_url }}">{{ link.get_comment_count }} comments</a> | {{ link.pubdate|timesince }} ago
    </p>
    {% endfor %}
    {% endwith %}
    {% else %}
    <div class="listcontent">
      {{ list.html_content|safe }}
    </div>
    {% endif %}
  </div>
</div>

{% if list.title not in default_lists %}
<div class="row">
  <div class="large-12 columns">
    {% display_comment_toplevel_for list %}
  </div>
</div>
{% endif %}
{% endblock %}


{% block last_body %}
{% if request.user.is_authenticated %}
<script type="text/javascript" src="{% static "js/jquery-ui/jquery-ui.min.js" %}" ></script>
<script type="text/javascript" src="{% static "js/tagit/tag-it.min.js" %}" ></script>
<script type="text/javascript">

</script>
<script type="text/javascript">
$(function(){
  $("#id_tags").tagit({
    availableTags: [{{ tags_addlink|safe }}],
    autocomplete: {delay: 0, minLength: 2}
  });

  $('.listcontent').find('a').each(function(index, item) {
    $item = $(item);
    if($item.text() === 'link') {
      $item.addClass('lsf symbol');
    }
  });

  $('.listcontent').find('a').each(function(idx){
    if($(this).hasClass('addthis')) {
      $(this).attr('id', idx)
      $(this).on('click', function() {
        var link = $(this).prev('a');
        var url = link.attr('href')
        var title = link.html();
        $('#id_url').val(url);
        $('#id_title').val(title);
        $('#addmodal').attr('data-link', idx);
        $('#addmodal').foundation('reveal', 'open');
      });
    }
  });


  $('#submit-id-submit').click(function(e) {
    e.preventDefault();
    var form = $('#create-link-form');
    var message = $('#form-message');
    $.ajax({
      type:"POST",
      url: form.attr('action'),
      data: 'id={{ list.pk }}&ajax=1&'+form.serialize(),
      error: function(xhr) {
        result = $.parseJSON(xhr.responseText).result;
        if (result == 'added') {
          $('#'+$('#addmodal').attr('data-link')).remove();
          $('#addmodal').foundation('reveal', 'close');
        } else {
          message.text('Error.');
          message.removeClass('success').addClass('alert');
        }
        message.show();
      },
    });
  });

  $('#vote,.votes').click(function() {
    var symbol = $('#vote');
    $.ajax({
      type:"POST",
      url:"{% url "list-upvote" list.pk %}",
      data: 'csrfmiddlewaretoken={{csrf_token}}',
      error: function(xhr) {
        result = $.parseJSON(xhr.responseText).result;
        console.log(result);
        if (result == 'success') {
          $(symbol).html('checkbox');
          $('.votes').html(parseInt($('.votes').html(), 10)+1);
        }
      }
    });
  });

});
</script>

<div id="addmodal" class="reveal-modal">
  <h2>Add this link</h2>
  <span id="form-message" class="label" style="display:none"></span>
  {% crispy form %}
  <a class="close-reveal-modal">&#215;</a>
</div>
{% else %}
<script>
$('.listcontent').find('a').each(function(){
  if($(this).hasClass('addthis')) {
    $(this).remove();
  }
});
</script>
{% endif %}
{% endblock last_body %}
